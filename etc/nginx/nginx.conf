user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
	# multi_accept on;
}

rtmp {
    server {
        listen 1935; # Listen on standard RTMP port
        chunk_size 4000;
        notify_method post;
        ping 30s;

        application live {
            live on;
            deny play all;
            on_publish http://127.0.0.1:23006/internal/streamauth;

            # exec ffmpeg -i rtmp://192.168.56.101/$app/$name -vcodec copy -map 0:a -map 0:v -acodec copy -f flv  rtmp://192.168.56.101/hls/$name;
            # exec ffmpeg -i rtmp://192.168.56.101/$app/$name -acodec copy -c:v libx264 -preset veryfast -profile:v baseline -vsync cfr -vf scale=-2:360,setdar=16:9 -b:v 400k -bufsize 400k -threads 0 -r 30 -f flv rtmp://192.168.56.101/low/${name};
        }

        application hls {
            live on;

            deny play all;
            allow publish 127.0.0.1;
            deny publish all;

            hls on;
            hls_path /tmp/hls/;
            hls_fragment 6s;
            hls_nested on;
            hls_playlist_length 60s;
            hls_variant _low BANDWIDTH=512000; # Low bitrate, sub-SD resolution
            hls_variant _mid BANDWIDTH=1024000; # Medium bitrate, SD resolution
            hls_variant _hd720 BANDWIDTH=2048000; # High bitrate, HD 720p resolution
        }

        application low {
            live on;
            hls on;
            hls_path /tmp/low/;
            hls_fragment 6s;
            hls_playlist_length 60s;
        }

        # Video on demand
        application vodflv {
            play /var/fluvicast/vod/flvs;
        }
        
        application vodmp4 {
            play /var/fluvicast/vod/mp4s;
        }

    }
}


http {

    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;

    server {
        listen       1844;
        server_name  192.168.56.101;

        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;                
            }

            root /tmp/;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header Access-Control-Allow-Methods "GET";
        }

        location /low {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }

            root /tmp/;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header Access-Control-Allow-Methods "GET";
        }

        location /vodmp4 {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }

            root /tmp/;
            add_header Cache-Control no-cache;
            add_header 'Access-Control-Allow-Origin' '*';
            add_header Access-Control-Allow-Methods "GET";
        }


    }

    server {
        listen 80;
        listen [::]:80;
        listen 443 ssl http2;
        listen [::]:443 ssl http2;

        # listen 80 default_server;
        server_name fluvicast.com www.fluvicast.com *.fluvicast.com 192.168.56.101;

        # ssl on;
        ssl_certificate /etc/fluvicast/ssl/fluvicast.crt;
        ssl_certificate_key /etc/fluvicast/ssl/fluvicast.key;

        location / {
            proxy_pass http://127.0.0.1:9176/;
            proxy_set_header X-Fluvicast-Forwarded-For $remote_addr;
            proxy_set_header X-Fluvicast-Host $host;
            # proxy_http_version 1.1;		# to keep alive
            # proxy_set_header Connection "";	# to keep alive
        }

        # if ($https = '') { return 301 https://$host$request_uri; }	# if not connected to HTTPS, perma redirect to HTTPS
        
        error_page 502 /502.html;
        location = /502.html {

            root  /var/fluvicast/err;

        }
    }

    server {
        listen 80;
        server_name fluvicast.me *.fluvicast.me 192.168.56.101:80;

        # ssl on;
        ssl_certificate /etc/fluvicast/ssl/fluvicast.crt;
        ssl_certificate_key /etc/fluvicast/ssl/fluvicast.key;

	location / {
            proxy_pass http://127.0.0.1:9177/;
            proxy_set_header X-Fluvicast-Forwarded-For $remote_addr;
            proxy_set_header X-Fluvicast-Host $host;
            # proxy_http_version 1.1;		# to keep alive
            # proxy_set_header Connection "";	# to keep alive
        }
        
        error_page 502 /502.html;
        location = /502.html {

            root  /var/fluvicast/err;

        }
    }

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        listen 443 default_server ssl http2;
        listen [::]:443 default_server ssl http2;

        # ssl on;
        ssl_certificate /etc/fluvicast/ssl/fluvicast.crt;
        ssl_certificate_key /etc/fluvicast/ssl/fluvicast.key;

        location / {
            proxy_pass http://127.0.0.1:4430/;
            proxy_set_header X-Fluvicast-Forwarded-For $remote_addr;
            proxy_set_header X-Fluvicast-Host $host;
            # proxy_http_version 1.1;		# to keep alive
            # proxy_set_header Connection "";	# to keep alive
        }

        # if ($https = '') { return 301 https://$host$request_uri; }	# if not connected to HTTPS, perma redirect to HTTPS
        
        error_page 502 /502.html;
        location = /502.html {

            root  /var/fluvicast/err;

        }
    }
}


# openssl req -x509 -newkey rsa:4096 -sha256 -days 3650 -nodes -keyout fluvicast.key -out fluvicast.crt -subj "/CN=fluvicast.com" -addext "subjectAltName=DNS:fluvicast.com,DNS:fluvicast.me,IP:192.168.56.101"
